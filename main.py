# -*- coding: utf-8 -*-
import logging
from datetime import datetime

from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor

# üîê –¢–û–ö–ï–ù –¢–í–û–ï–ì–û –ë–û–¢–ê
API_TOKEN = "8502500500:AAHw3Nvkefvbff27oeuwjdPrF-lXRxboiKQ"

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# ===== –°–ü–ò–°–û–ö –ú–ê–†–ö–ï–¢–û–í =====
MARKETS = [
    "–ú–∞—Ä–∫–µ—Ç B-01",
    "–ú–∞—Ä–∫–µ—Ç B-02",
    "–ú–∞—Ä–∫–µ—Ç B-03",
    "–ú–∞—Ä–∫–µ—Ç B-04",
    "–ú–∞—Ä–∫–µ—Ç B-05",
    "–ú–∞—Ä–∫–µ—Ç B-06",
    "–ú–∞—Ä–∫–µ—Ç B-07",
    "–ú–∞—Ä–∫–µ—Ç B-08",
    "–ú–∞—Ä–∫–µ—Ç B-09",
    "–ú–∞—Ä–∫–µ—Ç D-01",
    "–ú–∞—Ä–∫–µ—Ç D-02",
    "–ú–∞—Ä–∫–µ—Ç D-03",
    "–ú–∞—Ä–∫–µ—Ç D-04",
    "–ú–∞—Ä–∫–µ—Ç D-05",
    "–ú–∞—Ä–∫–µ—Ç D-06",
    "–ú–∞—Ä–∫–µ—Ç D-07",
    "–ú–∞—Ä–∫–µ—Ç D-08",
    "–ú–∞—Ä–∫–µ—Ç D-09",
    "–ú–∞—Ä–∫–µ—Ç D-10",
    "–ú–∞—Ä–∫–µ—Ç D-12",
    "–ú–∞—Ä–∫–µ—Ç D-14",
    "–ú–∞—Ä–∫–µ—Ç D-16",
    "–ú–∞—Ä–∫–µ—Ç D-18",
    "–ú–∞—Ä–∫–µ—Ç Dz-01",
    "–ú–∞—Ä–∫–µ—Ç Dz-02",
    "–ú–∞—Ä–∫–µ—Ç Dz-03",
    "–ú–∞—Ä–∫–µ—Ç K-01",
    "–ú–∞—Ä–∫–µ—Ç K-02",
    "–ú–∞—Ä–∫–µ—Ç K-03",
    "–ú–∞—Ä–∫–µ—Ç K-04",
    "–ú–∞—Ä–∫–µ—Ç K-05",
    "–ú–∞—Ä–∫–µ—Ç K-06",
    "–ú–∞—Ä–∫–µ—Ç K-07",
    "–ú–∞—Ä–∫–µ—Ç –ê-01",
    "–ú–∞—Ä–∫–µ—Ç –ê-02",
    "–ú–∞—Ä–∫–µ—Ç –ê-03",
    "–ú–∞—Ä–∫–µ—Ç –ê-04",
    "–ú–∞—Ä–∫–µ—Ç –ê-05",
    "–ú–∞—Ä–∫–µ—Ç –ê-06",
    "–ú–∞—Ä–∫–µ—Ç –ê-07",
    "–ú–∞—Ä–∫–µ—Ç –ê-08",
    "–ú–∞—Ä–∫–µ—Ç –ê-09",
    "–ú–∞—Ä–∫–µ—Ç –ê-10",
    "–ú–∞—Ä–∫–µ—Ç –ê-11",
    "–ú–∞—Ä–∫–µ—Ç –ê-12",
    "–ú–∞—Ä–∫–µ—Ç –ê-13",
    "–ú–∞—Ä–∫–µ—Ç –ê-14",
    "–ú–∞—Ä–∫–µ—Ç –ê-15",
    "–ú–∞—Ä–∫–µ—Ç –ê-16",
    "–ú–∞—Ä–∫–µ—Ç –ê-17",
    "–ú–∞—Ä–∫–µ—Ç –ê-18",
    "–ú–∞—Ä–∫–µ—Ç –ê-19",
    "–ú–∞—Ä–∫–µ—Ç –ê-20",
    "–ú–∞—Ä–∫–µ—Ç –ê-21",
    "–ú–∞—Ä–∫–µ—Ç –ê-22",
    "–ú–∞—Ä–∫–µ—Ç –ê-23",
    "–ú–∞—Ä–∫–µ—Ç –ê-24",
    "–ú–∞—Ä–∫–µ—Ç –ê-25",
    "–ú–∞—Ä–∫–µ—Ç –ê-27",
    "–ú–∞—Ä–∫–µ—Ç –ê-28",
    "–ú–∞—Ä–∫–µ—Ç –ê-29",
    "–ú–∞—Ä–∫–µ—Ç –ê-30",
    "–ú–∞—Ä–∫–µ—Ç –ê-31",
    "–ú–∞—Ä–∫–µ—Ç –ê-32",
    "–ú–∞—Ä–∫–µ—Ç –ê-34",
    "–ú–∞—Ä–∫–µ—Ç –ê-35",
    "–ú–∞—Ä–∫–µ—Ç –ú-02",
    "–ú–∞—Ä–∫–µ—Ç –ú-03",
    "–ú–∞—Ä–∫–µ—Ç –ú-04",
    "–ú–∞—Ä–∫–µ—Ç –ú-05",
    "–ú–∞—Ä–∫–µ—Ç –ú-06",
    "–ú–∞—Ä–∫–µ—Ç –ú-07",
    "–ú–∞—Ä–∫–µ—Ç –ú-08",
    "–ú–∞—Ä–∫–µ—Ç –ú-101",
    "–ú–∞—Ä–∫–µ—Ç –ú-102",
    "–ú–∞—Ä–∫–µ—Ç –ú-103",
    "–ú–∞—Ä–∫–µ—Ç –ú-104",
    "–ú–∞—Ä–∫–µ—Ç –ú-105",
    "–ú–∞—Ä–∫–µ—Ç –ú-106",
    "–ú–∞—Ä–∫–µ—Ç –ú-107",
    "–ú–∞—Ä–∫–µ—Ç –ú-108",
    "–ú–∞—Ä–∫–µ—Ç –ú-109",
    "–ú–∞—Ä–∫–µ—Ç –ú-11",
    "–ú–∞—Ä–∫–µ—Ç –ú-110",
    "–ú–∞—Ä–∫–µ—Ç –ú-111",
    "–ú–∞—Ä–∫–µ—Ç –ú-112",
    "–ú–∞—Ä–∫–µ—Ç –ú-113",
    "–ú–∞—Ä–∫–µ—Ç –ú-114",
    "–ú–∞—Ä–∫–µ—Ç –ú-115",
    "–ú–∞—Ä–∫–µ—Ç –ú-116",
    "–ú–∞—Ä–∫–µ—Ç –ú-117",
    "–ú–∞—Ä–∫–µ—Ç –ú-118",
    "–ú–∞—Ä–∫–µ—Ç –ú-119",
    "–ú–∞—Ä–∫–µ—Ç –ú-12",
    "–ú–∞—Ä–∫–µ—Ç –ú-120",
    "–ú–∞—Ä–∫–µ—Ç –ú-121",
    "–ú–∞—Ä–∫–µ—Ç –ú-122",
    "–ú–∞—Ä–∫–µ—Ç –ú-123",
    "–ú–∞—Ä–∫–µ—Ç –ú-124",
    "–ú–∞—Ä–∫–µ—Ç –ú-125",
    "–ú–∞—Ä–∫–µ—Ç –ú-126",
    "–ú–∞—Ä–∫–µ—Ç –ú-127",
    "–ú–∞—Ä–∫–µ—Ç –ú-128",
    "–ú–∞—Ä–∫–µ—Ç –ú-129",
    "–ú–∞—Ä–∫–µ—Ç –ú-13",
    "–ú–∞—Ä–∫–µ—Ç –ú-130",
    "–ú–∞—Ä–∫–µ—Ç –ú-131",
    "–ú–∞—Ä–∫–µ—Ç –ú-132",
    "–ú–∞—Ä–∫–µ—Ç –ú-133",
    "–ú–∞—Ä–∫–µ—Ç –ú-134",
    "–ú–∞—Ä–∫–µ—Ç –ú-135",
    "–ú–∞—Ä–∫–µ—Ç –ú-137",
    "–ú–∞—Ä–∫–µ—Ç –ú-139",
    "–ú–∞—Ä–∫–µ—Ç –ú-14",
    "–ú–∞—Ä–∫–µ—Ç –ú-140",
    "–ú–∞—Ä–∫–µ—Ç –ú-141",
    "–ú–∞—Ä–∫–µ—Ç –ú-142",
    "–ú–∞—Ä–∫–µ—Ç –ú-143",
    "–ú–∞—Ä–∫–µ—Ç –ú-144",
    "–ú–∞—Ä–∫–µ—Ç –ú-145",
    "–ú–∞—Ä–∫–µ—Ç –ú-146",
    "–ú–∞—Ä–∫–µ—Ç –ú-147",
    "–ú–∞—Ä–∫–µ—Ç –ú-148",
    "–ú–∞—Ä–∫–µ—Ç –ú-149",
    "–ú–∞—Ä–∫–µ—Ç –ú-151",
    "–ú–∞—Ä–∫–µ—Ç –ú-156",
    "–ú–∞—Ä–∫–µ—Ç –ú-16",
    "–ú–∞—Ä–∫–µ—Ç –ú-161",
    "–ú–∞—Ä–∫–µ—Ç –ú-164",
    "–ú–∞—Ä–∫–µ—Ç –ú-18",
    "–ú–∞—Ä–∫–µ—Ç –ú-19",
    "–ú–∞—Ä–∫–µ—Ç –ú-20",
    "–ú–∞—Ä–∫–µ—Ç –ú-21",
    "–ú–∞—Ä–∫–µ—Ç –ú-22",
    "–ú–∞—Ä–∫–µ—Ç –ú-23",
    "–ú–∞—Ä–∫–µ—Ç –ú-25",
    "–ú–∞—Ä–∫–µ—Ç –ú-26",
    "–ú–∞—Ä–∫–µ—Ç –ú-27",
    "–ú–∞—Ä–∫–µ—Ç –ú-28",
    "–ú–∞—Ä–∫–µ—Ç –ú-30",
    "–ú–∞—Ä–∫–µ—Ç –ú-31",
    "–ú–∞—Ä–∫–µ—Ç –ú-32",
    "–ú–∞—Ä–∫–µ—Ç –ú-33",
    "–ú–∞—Ä–∫–µ—Ç –ú-34",
    "–ú–∞—Ä–∫–µ—Ç –ú-35",
    "–ú–∞—Ä–∫–µ—Ç –ú-36",
    "–ú–∞—Ä–∫–µ—Ç –ú-37",
    "–ú–∞—Ä–∫–µ—Ç –ú-40",
    "–ú–∞—Ä–∫–µ—Ç –ú-41",
    "–ú–∞—Ä–∫–µ—Ç –ú-42",
    "–ú–∞—Ä–∫–µ—Ç –ú-43",
    "–ú–∞—Ä–∫–µ—Ç –ú-44",
    "–ú–∞—Ä–∫–µ—Ç –ú-45",
    "–ú–∞—Ä–∫–µ—Ç –ú-46",
    "–ú–∞—Ä–∫–µ—Ç –ú-47",
    "–ú–∞—Ä–∫–µ—Ç –ú-48",
    "–ú–∞—Ä–∫–µ—Ç –ú-49",
    "–ú–∞—Ä–∫–µ—Ç –ú-50",
    "–ú–∞—Ä–∫–µ—Ç –ú-51",
    "–ú–∞—Ä–∫–µ—Ç –ú-53",
    "–ú–∞—Ä–∫–µ—Ç –ú-55",
    "–ú–∞—Ä–∫–µ—Ç –ú-56",
    "–ú–∞—Ä–∫–µ—Ç –ú-57",
    "–ú–∞—Ä–∫–µ—Ç –ú-58",
    "–ú–∞—Ä–∫–µ—Ç –ú-59",
    "–ú–∞—Ä–∫–µ—Ç –ú-60",
    "–ú–∞—Ä–∫–µ—Ç –ú-61",
    "–ú–∞—Ä–∫–µ—Ç –ú-62",
    "–ú–∞—Ä–∫–µ—Ç –ú-63",
    "–ú–∞—Ä–∫–µ—Ç –ú-64",
    "–ú–∞—Ä–∫–µ—Ç –ú-65",
    "–ú–∞—Ä–∫–µ—Ç –ú-66",
    "–ú–∞—Ä–∫–µ—Ç –ú-67",
    "–ú–∞—Ä–∫–µ—Ç –ú-68",
    "–ú–∞—Ä–∫–µ—Ç –ú-69",
    "–ú–∞—Ä–∫–µ—Ç –ú-70",
    "–ú–∞—Ä–∫–µ—Ç –ú-71",
    "–ú–∞—Ä–∫–µ—Ç –ú-72",
    "–ú–∞—Ä–∫–µ—Ç –ú-73",
    "–ú–∞—Ä–∫–µ—Ç –ú-74",
    "–ú–∞—Ä–∫–µ—Ç –ú-75",
    "–ú–∞—Ä–∫–µ—Ç –ú-76",
    "–ú–∞—Ä–∫–µ—Ç –ú-78",
    "–ú–∞—Ä–∫–µ—Ç –ú-79",
    "–ú–∞—Ä–∫–µ—Ç –ú-80",
    "–ú–∞—Ä–∫–µ—Ç –ú-81",
    "–ú–∞—Ä–∫–µ—Ç –ú-82",
    "–ú–∞—Ä–∫–µ—Ç –ú-83",
    "–ú–∞—Ä–∫–µ—Ç –ú-84",
    "–ú–∞—Ä–∫–µ—Ç –ú-85",
    "–ú–∞—Ä–∫–µ—Ç –ú-86",
    "–ú–∞—Ä–∫–µ—Ç –ú-87",
    "–ú–∞—Ä–∫–µ—Ç –ú-88",
    "–ú–∞—Ä–∫–µ—Ç –ú-89",
    "–ú–∞—Ä–∫–µ—Ç –ú-90",
    "–ú–∞—Ä–∫–µ—Ç –ú-91",
    "–ú–∞—Ä–∫–µ—Ç –ú-92",
    "–ú–∞—Ä–∫–µ—Ç –ú-93",
    "–ú–∞—Ä–∫–µ—Ç –ú-95",
    "–ú–∞—Ä–∫–µ—Ç –ú-96",
    "–ú–∞—Ä–∫–µ—Ç –ú-97",
    "–ú–∞—Ä–∫–µ—Ç –ú-98",
    "–ú–∞—Ä–∫–µ—Ç –ú-99",
    "–ú–∞—Ä–∫–µ—Ç –°-01",
    "–ú–∞—Ä–∫–µ—Ç –°-03",
    "–ú–∞—Ä–∫–µ—Ç –°-04",
    "–ú–∞—Ä–∫–µ—Ç –°-05",
    "–ú–∞—Ä–∫–µ—Ç –°-06",
    "–ú–∞—Ä–∫–µ—Ç –°-07",
    "–ú–∞—Ä–∫–µ—Ç –°-08",
    "–ú–∞—Ä–∫–µ—Ç –°-09",
    "–ú–∞—Ä–∫–µ—Ç –°-10",
    "–ú–∞—Ä–∫–µ—Ç –°-11",
    "–ú–∞—Ä–∫–µ—Ç –°-12",
    "–ú–∞—Ä–∫–µ—Ç –°-13",
    "–ú–∞—Ä–∫–µ—Ç –°-14",
    "–ú–∞—Ä–∫–µ—Ç –°-15",
    "–ú–∞—Ä–∫–µ—Ç –°-16–¢",
    "–ú–∞—Ä–∫–µ—Ç –°-17",
    "–ú–∞—Ä–∫–µ—Ç –°-18",
    "–ú–∞—Ä–∫–µ—Ç –°-19",
    "–ú–∞—Ä–∫–µ—Ç –°-20",
    "–ú–∞—Ä–∫–µ—Ç –°-21",
    "–ú–∞—Ä–∫–µ—Ç –°-22",
    "–ú–∞—Ä–∫–µ—Ç –°-27",
    "–ú–∞—Ä–∫–µ—Ç –ú-153",
    "–ú–∞—Ä–∫–µ—Ç D-17",
    "–ú–∞—Ä–∫–µ—Ç D-15",
    "–ú–∞—Ä–∫–µ—Ç –°-23",
    "–ú–∞—Ä–∫–µ—Ç –ê-37",
    "–ú–∞—Ä–∫–µ—Ç S-01",
    "–ú–∞—Ä–∫–µ—Ç S-03",
    "–ú–∞—Ä–∫–µ—Ç S-06",
    "–ú–∞—Ä–∫–µ—Ç S-09",
    "–ú–∞—Ä–∫–µ—Ç –°-25",
    "–ú–∞—Ä–∫–µ—Ç Dz-04",
]

# —Å–∫–æ–ª—å–∫–æ –º–∞—Ä–∫–µ—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
PAGE_SIZE = 20

# —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º: –∂–¥—ë–º –≤—ã–±–æ—Ä –º–∞—Ä–∫–µ—Ç–∞ / –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
# user_id -> {"step": "choose_market"/"fill_template", "market_idx": int}
pending_reports = {}

# —Å—Ç–∞—Ç—É—Å –æ—Ç—á—ë—Ç–æ–≤ –ø–æ –º–∞—Ä–∫–µ—Ç–∞–º –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
daily_reports = {name: False for name in MARKETS}
current_date = datetime.now().date()


def reset_reports():
    """–°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç—á—ë—Ç–æ–≤ –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å."""
    global daily_reports, current_date
    current_date = datetime.now().date()
    daily_reports = {name: False for name in MARKETS}


def check_date_and_reset():
    """–ï—Å–ª–∏ –¥–µ–Ω—å —Å–º–µ–Ω–∏–ª—Å—è ‚Äî –æ–±–Ω—É–ª—è–µ–º –æ—Ç—á—ë—Ç—ã."""
    global current_date
    today = datetime.now().date()
    if today != current_date:
        reset_reports()


def make_markets_keyboard(page: int = 0) -> types.InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –≤—ã–±–æ—Ä–æ–º –º–∞—Ä–∫–µ—Ç–∞.
    2 —Å—Ç–æ–ª–±—Ü–∞, –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ.
    –í callback_data –ø–µ—Ä–µ–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å –º–∞—Ä–∫–µ—Ç–∞: m:<idx>
    """
    kb = types.InlineKeyboardMarkup(row_width=2)

    start = page * PAGE_SIZE
    end = min(len(MARKETS), start + PAGE_SIZE)

    buttons = []
    for idx in range(start, end):
        name = MARKETS[idx]
        buttons.append(
            types.InlineKeyboardButton(
                text=name,
                callback_data=f"m:{idx}",
            )
        )

    # —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥
    for i in range(0, len(buttons), 2):
        kb.row(*buttons[i:i + 2])

    # –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    nav_buttons = []
    if page > 0:
        nav_buttons.append(
            types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"p:{page - 1}")
        )
    if end < len(MARKETS):
        nav_buttons.append(
            types.InlineKeyboardButton("–í–ø–µ—Ä—ë–¥ ‚û°Ô∏è", callback_data=f"p:{page + 1}")
        )
    if nav_buttons:
        kb.row(*nav_buttons)

    return kb


@dp.message_handler(commands=["start", "help"])
async def cmd_start(message: types.Message):
    text = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Ñ–æ—Ç–æ-–æ—Ç—á—ë—Ç–æ–≤ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º.\n\n"
        "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å:\n"
        "1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –≤ —Ä–∞–±–æ—á—É—é –≥—Ä—É–ø–ø—É.\n"
        "2Ô∏è‚É£ –Ø –ø—Ä–µ–¥–ª–æ–∂—É –≤—ã–±—Ä–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω –∏–∑ —Å–ø–∏—Å–∫–∞.\n"
        "3Ô∏è‚É£ –Ø –ø—Ä–∏—à–ª—é —à–∞–±–ª–æ–Ω, —Ç—ã –µ–≥–æ –∑–∞–ø–æ–ª–Ω–∏—à—å —á–∏—Å–ª–∞–º–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—à—å.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/status ‚Äì –∫—Ç–æ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª –æ—Ç—á—ë—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è\n"
        "/reset ‚Äì –≤—Ä—É—á–Ω—É—é –æ–±–Ω—É–ª–∏—Ç—å –æ—Ç—á—ë—Ç—ã (–¥–ª—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ)"
    )
    await message.reply(text)


@dp.message_handler(commands=["reset"])
async def cmd_reset(message: types.Message):
    reset_reports()
    await message.answer("–û—Ç—á—ë—Ç—ã –æ–±–Ω—É–ª–µ–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –ñ–¥—É —Ñ–æ—Ç–æ –æ—Ç –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ç–æ–≤.")


@dp.message_handler(commands=["status"])
async def cmd_status(message: types.Message):
    check_date_and_reset()

    done = []
    not_done = []

    for name in MARKETS:
        if daily_reports.get(name):
            done.append(f"‚úÖ {name}")
        else:
            not_done.append(f"‚ùå {name}")

    today = datetime.now().date()
    text = f"–°—Ç–∞—Ç—É—Å –æ—Ç—á—ë—Ç–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({today}):\n\n"
    if done:
        text += "–û—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç—á—ë—Ç:\n" + "\n".join(done) + "\n\n"
    else:
        text += "–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª –æ—Ç—á—ë—Ç.\n\n"

    if not_done:
        text += "–ï—â—ë –ù–ï –æ—Ç–ø—Ä–∞–≤–∏–ª–∏:\n" + "\n".join(not_done)
    else:
        text += "–í—Å–µ –º–∞—Ä–∫–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç—á—ë—Ç. üëç"

    await message.answer(text)


# 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –≤—ã–±–æ—Ä –º–∞—Ä–∫–µ—Ç–∞
@dp.message_handler(content_types=types.ContentType.PHOTO)
async def handle_photo(message: types.Message):
    check_date_and_reset()

    user_id = message.from_user.id
    pending_reports[user_id] = {"step": "choose_market", "market_idx": None}

    await message.reply(
        "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –º–∞–≥–∞–∑–∏–Ω:",
        reply_markup=make_markets_keyboard(page=0),
    )


# 2. –ü–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü —Å–ø–∏—Å–∫–∞ –º–∞—Ä–∫–µ—Ç–æ–≤
@dp.callback_query_handler(lambda c: c.data.startswith("p:"))
async def page_callback(callback_query: types.CallbackQuery):
    try:
        page = int(callback_query.data.split(":", 1)[1])
    except ValueError:
        await callback_query.answer("–û—à–∏–±–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã", show_alert=True)
        return

    await callback_query.message.edit_reply_markup(
        make_markets_keyboard(page=page)
    )
    await callback_query.answer()  # —É–±–∏—Ä–∞–µ–º "—á–∞—Å–∏–∫"


# 3. –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ç–∞
@dp.callback_query_handler(lambda c: c.data.startswith("m:"))
async def market_callback(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    state = pending_reports.get(user_id)

    if not state or state.get("step") != "choose_market":
        await callback_query.answer(
            "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞. –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –µ—â—ë —Ä–∞–∑.",
            show_alert=True,
        )
        return

    try:
        idx = int(callback_query.data.split(":", 1)[1])
        market_name = MARKETS[idx]
    except (ValueError, IndexError):
        await callback_query.answer("–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –º–∞—Ä–∫–µ—Ç–∞", show_alert=True)
        return

    state["market_idx"] = idx
    state["step"] = "fill_template"

    template_text = (
        f"#–ú–∞–≥–∞–∑–∏–Ω: {market_name}\n"
        f"–û—Å—Ç–∞—Ç–∫–∏: \n"
        f"–•–ª–µ–±: \n"
        f"–õ–µ–ø–µ—à–∫–∏: \n"
        f"–ü–∞—Ç—ã—Ä: \n"
        f"–ê—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç: "
    )

    await callback_query.message.reply(
        "–¢–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω–∏ —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω –∏ –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:"
    )
    await callback_query.message.reply(f"<code>{template_text}</code>")
    await callback_query.answer("–ú–∞—Ä–∫–µ—Ç –≤—ã–±—Ä–∞–Ω ‚úÖ")


# 4. –ü—Ä–∏–Ω–∏–º–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
@dp.message_handler(content_types=types.ContentType.TEXT)
async def handle_template_text(message: types.Message):
    user_id = message.from_user.id
    state = pending_reports.get(user_id)

    if not state or state.get("step") != "fill_template":
        # —ç—Ç–æ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ —á–∞—Å—Ç—å –æ—Ç—á—ë—Ç–∞ ‚Äì –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        return

    market_idx = state.get("market_idx")
    if market_idx is None or not (0 <= market_idx < len(MARKETS)):
        pending_reports.pop(user_id, None)
        await message.reply("–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –µ—â—ë —Ä–∞–∑.")
        return

    market_name = MARKETS[market_idx]

    # –æ—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –º–∞—Ä–∫–µ—Ç –æ—Ç—á–∏—Ç–∞–ª—Å—è
    check_date_and_reset()
    daily_reports[market_name] = True

    # –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞
    logging.info(f"–û—Ç—á—ë—Ç –æ—Ç {user_id} ({market_name}):\n{message.text}")

    pending_reports.pop(user_id, None)
    await message.reply(f"–û—Ç—á—ë—Ç –¥–ª—è <b>{market_name}</b> —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ –°–ø–∞—Å–∏–±–æ!")


if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
